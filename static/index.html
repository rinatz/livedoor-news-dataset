<!DOCTYPE html>

<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>テキスト分類器</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" />

    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
</head>

<body>
    <nav class="navbar is-link" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <div class="navbar-item">テキスト分類器</div>
        </div>
    </nav>

    <section class="section">
        <div class="container">
            <h1 class="title">テキスト分類器</h1>
        </div>
    </section>

    <div class="section">
        <div id="app" class="container">
            <div class="field">
                <label class="label">入力テキスト</label>
                <div class="control">
                    <textarea class="textarea" placeholder="ここにテキストを入力してください" rows="5" v-model="text"></textarea>
                </div>
            </div>

            <div>
                <label class="label">判定結果</label>
                <canvas id="chart" height="100"></canvas>
            </div>
        </div>
    </div>

    <script>
        var vm = new Vue({
            el: "#app",
            data: {
                text: "",
                chart: null,
            },
            mounted: function () {
                this.$nextTick(function () {
                    this.chart = new Chart("chart");
                });
            },
            watch: {
                text: function (text) {
                    if (!text) {
                        this.chart.destroy();
                        return;
                    }

                    const url = `http://${location.host}/scores`;
                    const data = { text: text };

                    axios.post(url, data).then(resp => {
                        const top3BackgroundColor = [
                            "rgba(0, 150, 136, 0.2)",
                            "rgba(63, 81, 181, 0.2)",
                            "rgba(233, 30, 99, 0.2)",
                        ];
                        const top3BorderColor = [
                            "rgba(0, 150, 136, 1)",
                            "rgba(63, 81, 181, 1)",
                            "rgba(233, 30, 99, 1)",
                        ];

                        var backgroundColor = Array(resp.data.scores.length).fill("rgba(158, 158, 158, 0.2)");
                        var borderColor = Array(resp.data.scores.length).fill("rgba(158, 158, 158, 1)");

                        for (i = 0; i < Math.min(resp.data.scores.length, 3); ++i) {
                            backgroundColor[i] = top3BackgroundColor[i];
                            borderColor[i] = top3BorderColor[i];
                        }

                        const config = {
                            type: "horizontalBar",
                            data: {
                                labels: resp.data.scores.map(x => x["description"]),
                                datasets: [
                                    {
                                        backgroundColor,
                                        borderColor,
                                        label: "確率 [%]",
                                        data: resp.data.scores.map(x => x["value"] * 100),
                                        borderWidth: 1,
                                    }
                                ],
                            },
                            options: {
                                scales: {
                                    xAxes: [{ ticks: { min: 0, max: 100 } }]
                                }
                            }
                        };

                        this.chart.destroy();
                        this.chart = new Chart("chart", config);
                    });
                },
            },
        });
    </script>
</body>

</html>